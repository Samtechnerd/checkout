<!DOCTYPE html>
<html>
<head>
    <title>Tesco Checkout - Original Scanner</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        :root { --blue: #00539f; --red: #ee1c2e; --orange: #ff8a00; }
        body { font-family: Arial, sans-serif; margin: 0; background: white; overflow: hidden; }
        
        /* Orange Assistance Bar */
        #assistance-bar { display: none; background: var(--orange); color: white; padding: 15px; text-align: center; font-weight: bold; font-size: 20px; position: fixed; top: 0; width: 100%; z-index: 1000; cursor: pointer; }

        /* Welcome Screen */
        #welcome-screen { height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .hello { font-size: 80px; font-weight: bold; color: var(--blue); }
        .hello span { color: var(--red); }
        
        /* Scanning Screen */
        #scan-screen { display: none; height: 100vh; flex-direction: row; }
        #reader { width: 400px; height: 300px; background: #000; margin: 20px; border-radius: 10px; overflow: hidden; }
        .receipt { flex-grow: 1; background: #f9f9f9; padding: 30px; display: flex; flex-direction: column; }
        
        .btn-fill { background: var(--blue); color: white; padding: 20px 50px; border-radius: 50px; font-weight: bold; border: none; font-size: 20px; cursor: pointer; }
        .btn-outline { border: 2px solid var(--blue); color: var(--blue); background: white; padding: 15px 40px; border-radius: 50px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

    <div id="assistance-bar" onclick="startStaffVerify()">ASSISTANCE REQUIRED - SCAN STAFF CARD</div>

    <div id="welcome-screen">
        <div class="hello">Hello<span>.</span></div>
        <div style="margin-top:40px;">
            <button class="btn-fill" onclick="showScan()">Start Scanning</button>
            <button class="btn-outline" style="margin-left:15px;">Find item</button>
        </div>
        <div style="margin-top:50px;" onclick="callHelp()">
            <div style="border:2px solid var(--blue); width:50px; height:50px; border-radius:50%; margin:auto; display:flex; align-items:center; justify-content:center; color:var(--blue); font-weight:bold; cursor:pointer;">?</div>
            <p style="color:var(--blue); font-size:12px; font-weight:bold;">Assistance</p>
        </div>
    </div>

    <div id="scan-screen">
        <div style="width: 440px; display: flex; flex-direction: column; align-items: center;">
            <div id="reader"></div>
            <p id="status" style="color: var(--blue); font-weight: bold;">Ready to scan</p>
            <button class="btn-outline" onclick="location.reload()">Back</button>
        </div>
        <div class="receipt">
            <h2 style="color:var(--blue)">Basket</h2>
            <div id="basket-items" style="flex-grow:1; border-top:1px solid #ddd;"></div>
            <h1 id="total-price" style="text-align:right; font-size:48px;">£0.00</h1>
            <button class="btn-fill" style="width:100%">Pay Now</button>
        </div>
    </div>

    <script>
        // FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyAXtjM56OQso8g3RauOkT3h1ommplCelyE",
            authDomain: "checkout-c52ab.firebaseapp.com",
            projectId: "checkout-c52ab",
            storageBucket: "checkout-c52ab.firebasestorage.app",
            messagingSenderId: "486554411560",
            appId: "1:486554411560:web:9d24b172a86cfe1b2c0b1d"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let basket = [];
        let lastCode = "";
        let lastTime = 0;
        let isStaffMode = false;
        const html5QrCode = new Html5Qrcode("reader");

        function showScan() {
            document.getElementById('welcome-screen').style.display = 'none';
            document.getElementById('scan-screen').style.display = 'flex';
            
            // Start original-style scanning
            html5QrCode.start(
                { facingMode: "environment" }, 
                { fps: 10, qrbox: { width: 300, height: 150 } },
                onScanSuccess
            );
        }

        async function onScanSuccess(decodedText) {
            const now = Date.now();
            if (decodedText === lastCode && (now - lastTime) < 3000) return;
            lastCode = decodedText;
            lastTime = now;

            // STAFF VERIFICATION
            if (isStaffMode) {
                const staffDoc = await db.collection("staff").doc(decodedText).get();
                if (staffDoc.exists) {
                    isStaffMode = false;
                    document.getElementById('assistance-bar').style.display = 'none';
                    document.getElementById('status').innerText = "Cleared by " + staffDoc.data().name;
                }
                return;
            }

            // PRODUCT SCAN
            const doc = await db.collection("inventory").doc(decodedText).get();
            if (doc.exists) {
                basket.push(doc.data());
                renderBasket();
                document.getElementById('status').innerText = "Added: " + doc.data().name;
            } else {
                document.getElementById('status').innerText = "Unknown Item: " + decodedText;
            }
        }

        function renderBasket() {
            const list = document.getElementById('basket-items');
            let total = 0;
            list.innerHTML = basket.map(i => {
                total += i.price;
                return `<div style="display:flex; justify-content:space-between; padding:15px; border-bottom:1px solid #eee;">
                    <span>${i.name}</span><strong>£${i.price.toFixed(2)}</strong>
                </div>`;
            }).join('');
            document.getElementById('total-price').innerText = "£" + total.toFixed(2);
        }

        function callHelp() {
            document.getElementById('assistance-bar').style.display = 'block';
        }

        function startStaffVerify() {
            isStaffMode = true;
            alert("Please scan staff card now.");
        }
    </script>
</body>
</html>
