<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Self-Checkout Kiosk</title>
    <script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2/dist/quagga.min.js"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #27ae60; --danger: #c0392b; --staff: #f39c12; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; display: flex; height: 100vh; background: #f0f2f5; }
        
        /* Left Side: Scanner */
        #scanner-section { width: 45%; background: #000; position: relative; display: flex; flex-direction: column; justify-content: center; }
        #interactive.viewport { width: 100%; height: 100%; object-fit: cover; }
        .scan-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; pointer-events: none; }
        .reticle { width: 70%; height: 2px; background: red; box-shadow: 0 0 15px red; animation: scanAnim 2s infinite; }
        @keyframes scanAnim { 0%, 100% { transform: translateY(-50px); } 50% { transform: translateY(50px); } }

        /* Right Side: Cart */
        #cart-section { width: 55%; padding: 40px; display: flex; flex-direction: column; box-sizing: border-box; }
        .cart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .item-list { flex-grow: 1; background: white; border-radius: 15px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); overflow-y: auto; }
        .cart-item { display: flex; justify-content: space-between; padding: 15px 0; border-bottom: 1px solid #eee; font-size: 1.2rem; }
        .total-box { margin-top: 25px; padding: 20px; background: var(--primary); color: white; border-radius: 15px; text-align: right; }
        .total-box h2 { margin: 0; font-size: 2.5rem; }

        /* Staff Overlay */
        #staff-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 1000; color: white; flex-direction: column; align-items: center; justify-content: center; }
        .staff-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 30px; }
        .btn-staff { padding: 30px; font-size: 1.5rem; border: none; border-radius: 12px; cursor: pointer; transition: 0.2s; }
        
        .btn-pay { width: 100%; margin-top: 20px; padding: 20px; background: var(--accent); color: white; border: none; border-radius: 12px; font-size: 1.5rem; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

    <div id="staff-overlay">
        <h1 style="color: var(--staff);">üõ† MANAGER OVERRIDE</h1>
        <p id="staff-msg">Authorized personnel only</p>
        <div class="staff-grid">
            <button class="btn-staff" style="background: var(--staff);" onclick="voidLastItem()">VOID LAST ITEM</button>
            <button class="btn-staff" style="background: var(--danger); color: white;" onclick="restartCheckout()">CLEAR BASKET</button>
            <button class="btn-staff" style="grid-column: span 2; background: #555; color: white;" onclick="closeStaffMenu()">EXIT MENU</button>
        </div>
    </div>

    <div id="scanner-section">
        <div id="interactive" class="viewport"></div>
        <div class="scan-layer">
            <div class="reticle"></div>
            <p style="color: white; margin-top: 20px; background: rgba(0,0,0,0.5); padding: 5px 15px;">Align Barcode or Sync QR</p>
        </div>
    </div>

    <div id="cart-section">
        <div class="cart-header">
            <h1>Self-Checkout</h1>
            <span id="status-light" style="color: var(--accent);">‚óè System Ready</span>
        </div>

        <div class="item-list" id="cartDisplay">
            <div style="text-align: center; color: #999; margin-top: 50px;">
                <h3>Welcome!</h3>
                <p>Scan your first item to begin shopping.</p>
            </div>
        </div>

        <div class="total-section">
            <div class="total-box">
                <span>Amount Due</span>
                <h2 id="grandTotal">$0.00</h2>
            </div>
            <button class="btn-pay" onclick="alert('Proceeding to payment...')">PAY NOW</button>
        </div>
    </div>

<script>
    let cart = [];
    const STAFF_BARCODE = "STAFF99"; // Scan this code to unlock manager menu

    // 1. Initialize Scanner Logic
    Quagga.init({
        inputStream: {
            name: "Live",
            type: "LiveStream",
            target: document.querySelector('#interactive'),
            constraints: { facingMode: "environment" }
        },
        decoder: {
            // Support for Product Barcodes (EAN/UPC) and Manager Codes (Code 128)
            readers: ["code_128_reader", "ean_reader", "upc_reader", "qrcode_reader"]
        },
        locate: true
    }, (err) => {
        if (err) return console.error(err);
        Quagga.start();
    });

    let lastScanTime = 0;
    Quagga.onDetected((data) => {
        const code = data.codeResult.code;
        const now = Date.now();

        // Prevent rapid double-scanning (2 second cooldown)
        if (now - lastScanTime < 2000) return;
        lastScanTime = now;

        processInput(code);
    });

    // 2. Main Logic Engine
    function processInput(code) {
        // A. Handle Staff Card
        if (code === STAFF_BARCODE) {
            document.getElementById('staff-overlay').style.display = 'flex';
            return;
        }

        // B. Handle Mobile Sync QR (Format: SYNC:id,id,id)
        if (code.startsWith("SYNC:")) {
            const rawIds = code.replace("SYNC:", "").split(",");
            const inventory = JSON.parse(localStorage.getItem('inventory')) || [];
            
            rawIds.forEach(id => {
                const product = inventory.find(p => p.id === id);
                if (product) cart.push(product);
            });
            updateUI();
            return;
        }

        // C. Handle Standard Product Barcode
        const inventory = JSON.parse(localStorage.getItem('inventory')) || [];
        const product = inventory.find(p => p.id === code);

        if (product) {
            cart.push(product);
            updateUI();
        } else {
            console.warn("Unknown Item: " + code);
        }
    }

    // 3. UI Update Logic
    function updateUI() {
        const display = document.getElementById('cartDisplay');
        let total = 0;

        if (cart.length === 0) {
            display.innerHTML = `<div style="text-align: center; color: #999; margin-top: 50px;"><h3>Basket Cleared</h3><p>Scan an item to start.</p></div>`;
        } else {
            display.innerHTML = cart.map((item, index) => {
                total += parseFloat(item.price);
                return `
                    <div class="cart-item">
                        <span>${item.name}</span>
                        <strong>$${parseFloat(item.price).toFixed(2)}</strong>
                    </div>
                `;
            }).join('');
        }

        document.getElementById('grandTotal').innerText = `$${total.toFixed(2)}`;
    }

    // 4. Staff Functions
    function voidLastItem() {
        cart.pop();
        updateUI();
        closeStaffMenu();
    }

    function restartCheckout() {
        cart = [];
        updateUI();
        closeStaffMenu();
    }

    function closeStaffMenu() {
        document.getElementById('staff-overlay').style.display = 'none';
    }
</script>
</body>
</html>
