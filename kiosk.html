<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tesco Kiosk Rebuild</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        :root { --tesco-blue: #00539f; --tesco-red: #ee1c2e; --bg-grey: #f3f3f3; --green-pay: #008137; }
        body { margin: 0; font-family: Arial, sans-serif; background: white; overflow: hidden; -webkit-user-select: none; }
        
        /* Navigation & Screens */
        .screen { display: none; width: 100vw; height: 100vh; }
        .active { display: flex; flex-direction: column; }

        /* HEADER [cite: 1, 8] */
        .header { background: var(--tesco-blue); color: white; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 1.8rem; font-weight: bold; cursor: pointer; }
        .assistance-btn { background: white; color: var(--tesco-blue); border: none; padding: 10px 20px; border-radius: 25px; font-weight: bold; }

        /* START SCREEN  */
        #start-screen { background: url('https://www.tesco.com/groceries/en-GB/resources/images/background-peas.jpg') center/cover; justify-content: center; align-items: center; }
        .welcome-card { background: white; width: 85%; padding: 50px; border-radius: 12px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .card-only-title { font-size: 5rem; margin: 0 0 30px 0; }
        .options-grid { display: flex; justify-content: space-around; align-items: center; }
        .divider { width: 1px; height: 180px; background: #ccc; border-left: 2px dashed #ccc; }

        /* BASKET VIEW [cite: 14, 16, 18, 20, 21, 22] */
        .main-layout { display: flex; flex: 1; height: calc(100vh - 70px); }
        .basket-list { flex: 2; padding: 20px; overflow-y: auto; }
        .sidebar { flex: 1; background: var(--bg-grey); padding: 30px; display: flex; flex-direction: column; border-left: 1px solid #ddd; }
        .item-row { display: flex; justify-content: space-between; padding: 20px; border-bottom: 1px solid #ddd; font-size: 1.5rem; }
        .total-area { background: white; padding: 30px; border-radius: 15px; text-align: center; margin-top: auto; }
        .pay-btn { background: var(--green-pay); color: white; border: none; width: 100%; padding: 25px; border-radius: 50px; font-size: 2.5rem; font-weight: bold; margin-top: 20px; }

        /* PAYMENT SCREEN  */
        #payment-screen { text-align: center; padding: 50px; background: white; }
        .payment-grid { display: flex; justify-content: center; gap: 50px; margin-top: 50px; }
        .pay-option-icon { width: 150px; height: 150px; background: var(--tesco-blue); border-radius: 50%; display: flex; justify-content: center; align-items: center; margin: 0 auto 15px; }
    </style>
</head>
<body>

    <div id="start-screen" class="screen active">
        <div class="welcome-card">
            <h1 class="card-only-title">Card Only</h1>
            <div class="options-grid">
                <div>
                    <img src="https://img.icons8.com/ios-filled/100/00539f/shopping-basket-2.png" alt="Basket">
                    <h2>Self service</h2>
                    <p>Please Scan Your first item<br>or tap Here to Start</p>
                </div>
                <div class="divider"></div>
                <div>
                    <img src="https://img.icons8.com/ios/100/000000/barcode.png" alt="Barcode">
                    <h2>Scan as you Shop</h2>
                    <p>Please Scan this Barcode<br>to start</p>
                </div>
            </div>
        </div>
    </div>

    <div id="basket-screen" class="screen">
        <div class="header">
            <div class="logo" onclick="resetSystem()">TESCO</div>
            <button class="assistance-btn">Assistance</button>
        </div>
        <div class="main-layout">
            <div class="basket-list" id="itemList"></div>
            <div class="sidebar">
                <button style="padding:15px; margin-bottom:10px; background:white; border:1px solid #ccc; font-weight:bold;">Find item</button>
                <button style="padding:15px; margin-bottom:10px; background:white; border:1px solid #ccc; font-weight:bold;">Own Bag</button>
                <div class="total-area">
                    <p style="margin:0; font-weight:bold; color:#666;">TOTAL</p>
                    <h1 id="grandTotal" style="font-size: 4rem; margin: 10px 0;">€0.00</h1>
                    <button class="pay-btn" onclick="showPayment()">Pay</button>
                </div>
            </div>
        </div>
    </div>

    <div id="payment-screen" class="screen">
        <div class="header">
            <div class="logo" onclick="resetSystem()">TESCO</div>
            <button class="assistance-btn">Assistance</button>
        </div>
        <h1 style="margin-top:50px;">Don't Forget to scan your Clubcard</h1>
        <div class="payment-grid">
            <div><div class="pay-option-icon"><img src="https://img.icons8.com/ios-filled/80/ffffff/bank-card-backside.png"></div><h3>Card</h3></div>
            <div><div class="pay-option-icon"><img src="https://img.icons8.com/ios-filled/80/ffffff/ticket.png"></div><h3>Coupons</h3></div>
            <div><div class="pay-option-icon"><img src="https://img.icons8.com/ios-filled/80/ffffff/gift-card.png"></div><h3>Gift Card</h3></div>
        </div>
        <div style="margin-top:100px;">
            <h2 id="payFinalTotal">TOTAL TO PAY: €0.00</h2>
        </div>
    </div>

    <script>
        const firebaseConfig = { 
            apiKey: "AIzaSyAXtjM56OQso8g3RauOkT3h1ommplCelyE", 
            authDomain: "checkout-c52ab.firebaseapp.com", 
            projectId: "checkout-c52ab", 
            storageBucket: "checkout-c52ab.firebasestorage.app", 
            messagingSenderId: "486554411560", 
            appId: "1:486554411560:web:9d24b172a86cfe1b2c0b1d" 
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // 1. LISTEN FOR CHANGES
        db.collection("terminal_111").onSnapshot((snap) => {
            const start = document.getElementById('start-screen');
            const basket = document.getElementById('basket-screen');
            const payment = document.getElementById('payment-screen');

            if (snap.empty) {
                start.classList.add('active');
                basket.classList.remove('active');
                payment.classList.remove('active');
                return;
            }

            // Only switch to basket if we aren't already on the payment screen
            if (!payment.classList.contains('active')) {
                start.classList.remove('active');
                basket.classList.add('active');
            }

            let total = 0;
            let html = '';
            snap.forEach(doc => {
                const item = doc.data();
                html += `<div class="item-row"><span>${item.name}</span><b>€${item.price.toFixed(2)}</b></div>`;
                total += item.price;
            });
            
            document.getElementById('itemList').innerHTML = html;
            document.getElementById('grandTotal').innerText = '€' + total.toFixed(2);
            document.getElementById('payFinalTotal').innerText = 'TOTAL TO PAY: €' + total.toFixed(2);
        });

        // 2. NAVIGATION FUNCTIONS
        function showPayment() {
            document.getElementById('basket-screen').classList.remove('active');
            document.getElementById('payment-screen').classList.add('active');
        }

        async function resetSystem() {
            if(confirm("Clear current session?")) {
                const snap = await db.collection("terminal_111").get();
                const batch = db.batch();
                snap.forEach(doc => batch.delete(doc.ref));
                await batch.commit();
            }
        }
    </script>
</body>
</html>
