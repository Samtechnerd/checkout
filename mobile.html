<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tesco Shop & Scan</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        :root { --blue: #00539f; --yellow: #fff200; }
        body { font-family: Arial; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        #reader { height: 25vh; background: black; }
        #list { flex-grow: 1; overflow-y: auto; padding: 10px; }
        .zebra-bar { display: flex; height: 60px; border-top: 2px solid #ccc; }
        .savings { background: var(--yellow); width: 40%; padding: 10px; font-weight: bold; }
        .total { background: var(--blue); color: white; width: 60%; padding: 10px; text-align: right; font-size: 20px; font-weight: bold; }
        #sync-box { display: none; position: fixed; inset: 0; background: white; z-index: 100; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body>
    <div id="reader"></div>
    <div id="list"></div>
    
    <div class="zebra-bar" onclick="showSync()">
        <div class="savings">Savings<br>£0.00</div>
        <div class="total">Total<br><span id="total-val">£0.00</span></div>
    </div>

    <div id="sync-box">
        <h2>Scan at Checkout</h2>
        <div id="qrcode"></div>
        <button onclick="document.getElementById('sync-box').style.display='none'">Back</button>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyAXtjM56OQso8g3RauOkT3h1ommplCelyE", authDomain: "checkout-c52ab.firebaseapp.com", projectId: "checkout-c52ab", storageBucket: "checkout-c52ab.firebasestorage.app", messagingSenderId: "486554411560", appId: "1:486554411560:web:9d24b172a86cfe1b2c0b1d" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let basket = [];
        let lastScan = 0;

        const html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start({ facingMode: "environment" }, { fps: 15, qrbox: 250 }, onScan);

        async function onScan(code) {
            if (Date.now() - lastScan < 2000) return;
            lastScan = Date.now();

            const doc = await db.collection("inventory").doc(code).get();
            if (doc.exists) {
                basket.push(doc.data());
                updateUI();
                if(navigator.vibrate) navigator.vibrate(100);
            }
        }

        function updateUI() {
            let total = 0;
            document.getElementById('list').innerHTML = basket.map(i => {
                total += i.price;
                return `<div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #eee;"><span>${i.name}</span><span>£${i.price.toFixed(2)}</span></div>`;
            }).join('');
            document.getElementById('total-val').innerText = "£" + total.toFixed(2);
        }

        function showSync() {
            if(basket.length === 0) return;
            document.getElementById('sync-box').style.display = 'flex';
            document.getElementById('qrcode').innerHTML = "";
            new QRCode(document.getElementById("qrcode"), { text: "SYNC:" + basket.map(i => i.id).join(","), width: 250, height: 250 });
        }
    </script>
</body>
</html>
