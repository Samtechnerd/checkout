<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobile Shop & Scan</title>
    <script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2/dist/quagga.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; background: #f8f9fa; padding: 15px; }
        #scanner-mobile { width: 100%; height: 200px; background: #000; border-radius: 15px; overflow: hidden; position: relative; }
        .basket-item { background: white; padding: 10px; margin: 10px 0; border-radius: 8px; display: flex; justify-content: space-between; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        #transfer-overlay { display: none; position: fixed; inset: 0; background: white; z-index: 100; flex-direction: column; align-items: center; justify-content: center; padding: 20px; text-align: center; }
        #qrcode { margin: 20px; }
        .btn { width: 100%; padding: 15px; border: none; border-radius: 8px; font-size: 1rem; cursor: pointer; margin-top: 10px; }
        .btn-finish { background: #007bff; color: white; }
        .btn-close { background: #6c757d; color: white; }
    </style>
</head>
<body>

    <h2>ðŸ“± Shop & Scan</h2>
    <div id="scanner-mobile"></div>
    
    <h3>Your Basket</h3>
    <div id="mobileBasket"></div>
    
    <button class="btn btn-finish" onclick="generateTransferCode()">Transfer to Checkout</button>

    <div id="transfer-overlay">
        <h2>Scan this at Kiosk</h2>
        <p>Hold this QR code up to the self-checkout webcam to pay.</p>
        <div id="qrcode"></div>
        <button class="btn btn-close" onclick="document.getElementById('transfer-overlay').style.display='none'">Go Back</button>
    </div>

<script>
    let myBasket = [];
    
    // Start Camera
    Quagga.init({
        inputStream: { name: "Live", type: "LiveStream", target: document.querySelector('#scanner-mobile'), constraints: { facingMode: "environment" } },
        decoder: { readers: ["code_128_reader", "ean_reader", "upc_reader"] }
    }, (err) => { if (!err) Quagga.start(); });

    let lastScan = 0;
    Quagga.onDetected((data) => {
        let now = Date.now();
        if (now - lastScan < 2000) return;
        lastScan = now;

        const code = data.codeResult.code;
        // In this mobile version, we check the local "inventory" to show names
        const inventory = JSON.parse(localStorage.getItem('inventory')) || [];
        const item = inventory.find(p => p.id === code);
        
        if (item) {
            myBasket.push(item);
            renderBasket();
        }
    });

    function renderBasket() {
        const div = document.getElementById('mobileBasket');
        div.innerHTML = myBasket.map(i => `<div class="basket-item"><span>${i.name}</span><span>$${i.price}</span></div>`).join('');
    }

    function generateTransferCode() {
        if (myBasket.length === 0) return alert("Basket is empty!");
        
        // Convert basket into a comma-separated list of IDs
        // Format: SYNC:123,123,456
        const syncData = "SYNC:" + myBasket.map(i => i.id).join(",");
        
        document.getElementById('transfer-overlay').style.display = 'flex';
        document.getElementById('qrcode').innerHTML = ""; // Clear old QR
        new QRCode(document.getElementById("qrcode"), {
            text: syncData,
            width: 250,
            height: 250
        });
    }
</script>
</body>
</html>