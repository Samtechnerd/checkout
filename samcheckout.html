<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Sam's Shop - Interactive Display</title>
    <style>
        body { margin: 0; font-family: 'Arial', sans-serif; overflow: hidden; background: #333; user-select: none; }
        .screen { display: none; height: 100vh; background: white; flex-direction: column; }
        .active { display: flex; }

        /* HEADER */
        .header { background-color: #4CAF50; color: white; padding: 20px; text-align: center; font-size: 28px; font-weight: bold; position: relative; }
        .sub-header { font-size: 16px; font-weight: normal; margin-top: 5px; }
        
        /* ASSISTANCE BUTTON (Top Right) */
        .btn-assist-top { position: absolute; right: 20px; top: 20px; background: #ff9800; border: 2px solid white; color: white; font-weight: bold; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; }

        /* WELCOME STATE */
        #view-welcome { align-items: center; justify-content: center; text-align: center; cursor: pointer; }
        .tap-icon { font-size: 100px; margin-bottom: 20px; animation: bounce 2s infinite; }
        .card-only { color: red; border: 3px solid red; padding: 10px 30px; font-weight: bold; display: inline-block; margin-top: 20px; font-size: 20px;}

        /* SCANNING STATE */
        #view-scanning { justify-content: flex-start; }
        .cart-list { flex-grow: 1; padding: 20px; overflow-y: auto; background: #fff; }
        .cart-item { display: flex; justify-content: space-between; padding: 15px 0; border-bottom: 1px solid #eee; font-size: 22px; }
        
        .footer { background: #222; color: white; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .total-row { display: flex; justify-content: space-between; font-size: 40px; font-weight: bold; }
        
        .action-row { display: flex; gap: 20px; height: 80px; }
        .btn { flex: 1; border: none; border-radius: 8px; font-size: 28px; font-weight: bold; cursor: pointer; color: white; }
        .btn-pay { background-color: #4CAF50; }
        .btn-pay:active { background-color: #388E3C; }
        .btn-help { background-color: #ff9800; flex: 0.3; }

        /* PAYING STATE OVERLAY */
        #overlay-paying { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; flex-direction: column; color: white; z-index: 999; }
        .instruction { font-size: 40px; margin-bottom: 20px; text-align: center; }

        /* SUCCESS STATE */
        #view-success { align-items: center; justify-content: center; background: #e8f5e9; }
        .success-text { font-size: 50px; color: #2e7d32; font-weight: bold; margin-top: 20px; text-align: center;}

        /* ANIMATIONS */
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }
        .flashing-border { animation: flash-red 1s infinite; border: 10px solid red !important; box-sizing: border-box; }
        @keyframes flash-red { 0%, 100% { border-color: red; } 50% { border-color: transparent; } }
    </style>
</head>
<body>

    <div id="view-welcome" class="screen active" onclick="startShop()">
        <div class="header" style="width: 100%; position: absolute; top: 0;">
            Off you POP To Sam's Shop
            <div class="sub-header">Co. Dublin Howth</div>
            <button class="btn-assist-top" onclick="event.stopPropagation(); callAssistance()">Assistance</button>
        </div>
        
        <div class="tap-icon">ðŸ‘†</div>
        <h1>Tap Here Or Scan</h1>
        <p>Your first item to Start</p>
        <div class="card-only">CARD ONLY</div>
    </div>

    <div id="view-scanning" class="screen">
        <div class="header">
            Sam's Shop
            <div class="sub-header">Scanning...</div>
            <button class="btn-assist-top" onclick="callAssistance()">Assistance</button>
        </div>

        <div class="cart-list" id="cart-container">
            <div style="text-align: center; color: #aaa; margin-top: 50px;">Scan items...</div>
        </div>

        <div id="overlay-paying">
            <div style="font-size: 80px;">ðŸ’³</div>
            <div class="instruction">Please use the card terminal<br>to complete payment</div>
            <button onclick="cancelPay()" style="padding: 15px 30px; font-size: 20px; background: #d32f2f; color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 30px;">Cancel</button>
        </div>

        <div class="footer">
            <div class="total-row">
                <span>TOTAL</span>
                <span id="total-price">â‚¬0.00</span>
            </div>
            <div class="action-row">
                <button class="btn btn-help" onclick="callAssistance()">Help</button>
                <button class="btn btn-pay" onclick="initiatePay()">Pay Now</button>
            </div>
        </div>
    </div>

    <div id="view-success" class="screen">
        <div style="font-size: 100px;">âœ…</div>
        <div class="success-text">Thanks for shopping<br>at Sam's Shop</div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAXtjM56OQso8g3RauOkT3h1ommplCelyE",
            authDomain: "checkout-c52ab.firebaseapp.com",
            projectId: "checkout-c52ab",
            databaseURL: "https://checkout-c52ab-default-rtdb.europe-west1.firebasedatabase.app",
            storageBucket: "checkout-c52ab.firebasestorage.app",
            messagingSenderId: "486554411560",
            appId: "1:486554411560:web:9d24b172a86cfe1b2c0b1d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- BUTTON ACTIONS (Writing to Firebase) ---

        window.startShop = function() {
            // Clicking "Tap to Start" -> Sets status to 'scanning'
            // Using update to preserve cart if any, or just set new session
            set(ref(db, 'session/status'), 'scanning');
        };

        window.initiatePay = function() {
            // Clicking "Pay Now" -> Sets status to 'paying' (Wakes up Terminal)
            set(ref(db, 'session/status'), 'paying');
        };

        window.cancelPay = function() {
            // Cancel on overlay -> Go back to scanning
            set(ref(db, 'session/status'), 'scanning');
        };

        window.callAssistance = function() {
            // Clicking Assistance -> Flashes screen locally + could log to DB
            document.body.classList.toggle('flashing-border');
            alert("STAFF CALLED: Please wait for assistance.");
        };

        // --- LISTENING TO FIREBASE (Reading Updates) ---
        
        onValue(ref(db, 'session'), (snapshot) => {
            const data = snapshot.val();
            if (!data) return; // Wait for data

            // 1. Manage View Switching
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
            const overlay = document.getElementById('overlay-paying');

            if (data.status === 'welcome') {
                document.getElementById('view-welcome').classList.add('active');
                overlay.style.display = 'none';
            } 
            else if (data.status === 'scanning') {
                document.getElementById('view-scanning').classList.add('active');
                overlay.style.display = 'none';
                renderCart(data.cart);
            }
            else if (data.status === 'paying') {
                // Stay on scanning screen but show overlay
                document.getElementById('view-scanning').classList.add('active');
                overlay.style.display = 'flex'; // Show "Look at terminal" overlay
                renderCart(data.cart);
            }
            else if (data.status === 'success') {
                document.getElementById('view-success').classList.add('active');
                overlay.style.display = 'none';
                
                // Reset to welcome after 5 seconds
                setTimeout(() => {
                    set(ref(db, 'session'), { status: 'welcome', cart: {} });
                }, 5000);
            }
        });

        function renderCart(cartData) {
            const container = document.getElementById('cart-container');
            if (!cartData) {
                container.innerHTML = '<div style="text-align: center; color: #aaa; margin-top: 50px;">Scan items...</div>';
                document.getElementById('total-price').innerText = "â‚¬0.00";
                return;
            }

            container.innerHTML = '';
            let total = 0;

            Object.values(cartData).forEach(item => {
                total += item.price;
                container.innerHTML += `
                    <div class="cart-item">
                        <div>
                            ${item.name}
                            ${item.is_deposit ? '<div style="font-size:14px;color:#666">+ Deposit included</div>' : ''}
                        </div>
                        <div>â‚¬${item.price.toFixed(2)}</div>
                    </div>`;
            });
            document.getElementById('total-price').innerText = "â‚¬" + total.toFixed(2);
        }
    </script>
</body>
</html>
